import { Component, OnInit } from '@angular/core';
import * as mapboxgl from 'mapbox-gl';
import { AuthService } from '../shared/services/auth.service';
import { HttpClient } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { PlottingService } from '../shared/services/plotting.service';

@Component({
  selector: 'app-backend',
  templateUrl: './backend.component.html',
  styleUrls: ['./backend.component.scss']
})
export class BackendComponent implements OnInit {
  


  map: mapboxgl.Map;
  style;
  lat = 53.340602;
  lng = -6.281422;
  start = [];
  end = [];
  dir;
  plot_direction;
  locate;



  constructor(public _plot: PlottingService,
              public authService: AuthService,
              public _http: HttpClient,
              ) {
              }

  ngOnInit() {
    
    this.initializeMap();
    this.search(this.locate);

  }

  search(location){
    if(location){

      this.locate = location;

      let api =`https://api.mapbox.com/geocoding/v5/mapbox.places/${location}%20dublin.json?access_token=pk.eyJ1IjoiY2F2aW5uIiwiYSI6ImNqZW9nNjduejVrcTIyd21xMGhsYnB0bGwifQ.d1szzRngrK0u-qP_aiD64A`;

      
      console.log(location)

      return this._http.get(api)
        .pipe(
          tap((res: any) => res)
        ).subscribe(locations => {
          
          let loc_lat = locations.features[0].bbox[1]
          let loc_lng = locations.features[0].bbox[0]

          this.map.flyTo({
            center: [loc_lng, loc_lat],
            zoom: 14,
          });
        });
    }
  }

  private initializeMap() {
    /// locate the user
    if (navigator.geolocation) {
       navigator.geolocation.getCurrentPosition(position => {
        let lat = position.coords.latitude;
        let lng = position.coords.longitude;
        this.map.flyTo({
          center: [lng, lat],
          zoom: 14,
        })
      });
    }

    this.buildMap()

  }

  buildMap() {
    mapboxgl.accessToken = 'pk.eyJ1IjoiY2F2aW5uIiwiYSI6ImNqZW9nNjduejVrcTIyd21xMGhsYnB0bGwifQ.d1szzRngrK0u-qP_aiD64A';

      this.map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        zoom: 10,
        center: [this.lng, this.lat]
      });

      this.directions();
      this.m50();
  }
  

  directions(){
    let palmerstown = [-6.375164, 53.353620]
    let lights = [-6.373624, 53.355309]
    // look at api
    const directions_api = `https://api.mapbox.com/directions/v5/mapbox/driving/${lights};${palmerstown}?geometries=geojson&access_token=pk.eyJ1IjoiY2F2aW5uIiwiYSI6ImNqZW9nNjduejVrcTIyd21xMGhsYnB0bGwifQ.d1szzRngrK0u-qP_aiD64A`;


    this.map.on('load', (event) => {
      return this._http.get(directions_api)
        .pipe(
          tap((res: any) => res)
        ).subscribe(directions => {
            
            this.dir = directions

                  this.map.addLayer({
                    "id": "1",
                      "type": "line",
                      "source": {
                          "type": "geojson",
                          "data": {
                            "type": 'Feature',
                            "properties": {},
                            "geometry": directions.routes[0].geometry
                          }
                      },
                      "layout": {
                          "line-join": "round",
                          "line-cap": "round"
                      },
                      "paint": {
                          "line-color": "blue",
                          "line-width": 3
                      }
          });
        });
    });

  }

  m50(){

    this.map.on('load', (event) => {

                  this.map.addLayer({
                    "id": "route",
                      "type": "line",
                      "source": {
                          "type": "geojson",
                          "data": {
                            "type": "Feature",
                            "properties": {},
                            "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                        [
                                          -6.2310075759887695,
                                          53.41032487106853
                                        ],
                                        [
                                          -6.232359409332275,
                                          53.410401613959614
                                        ],
                                        [
                                          -6.234698295593262,
                                          53.41029929007409
                                        ],
                                        [
                                          -6.237616539001465,
                                          53.410222546998384
                                        ],
                                        [
                                          -6.2393975257873535,
                                          53.41012022268209
                                        ],
                                        [
                                          -6.242315769195557,
                                          53.41001789811961
                                        ],
                                        [
                                          -6.249074935913086,
                                          53.409736504303645
                                        ],
                                        [
                                          -6.260340213775635,
                                          53.40922487441448
                                        ],
                                        [
                                          -6.277248859405517,
                                          53.408508582231136
                                        ],
                                        [
                                          -6.296238899230956,
                                          53.40753645211841
                                        ],
                                        [
                                          -6.300616264343261,
                                          53.40702479576743
                                        ],
                                        [
                                          -6.3054656982421875,
                                          53.40600146460342
                                        ],
                                        [
                                          -6.308255195617676,
                                          53.405285118141975
                                        ],
                                        [
                                          -6.317213773727417,
                                          53.40207420277231
                                        ],
                                        [
                                          -6.317208409309387,
                                          53.402075801894064
                                        ],
                                        [
                                          -6.317742168903351,
                                          53.40189669988452
                                        ],
                                        [
                                          -6.318233013153076,
                                          53.401715997985875
                                        ],
                                        [
                                          -6.318782866001129,
                                          53.40150970903958
                                        ],
                                        [
                                          -6.3194024562835684,
                                          53.40128742758264
                                        ],
                                        [
                                          -6.320027410984039,
                                          53.40107314076224
                                        ],
                                        [
                                          -6.321043968200684,
                                          53.40069893581651
                                        ],
                                        [
                                          -6.321652829647064,
                                          53.400471852578306
                                        ],
                                        [
                                          -6.32213830947876,
                                          53.40029114462849
                                        ],
                                        [
                                          -6.3226452469825745,
                                          53.400100840736606
                                        ],
                                        [
                                          -6.323074400424957,
                                          53.39992812722408
                                        ],
                                        [
                                          -6.323495507240295,
                                          53.39978100034565
                                        ],
                                        [
                                          -6.323895156383514,
                                          53.39962907531774
                                        ],
                                        [
                                          -6.326035559177399,
                                          53.39882306399214
                                        ],
                                        [
                                          -6.326644420623779,
                                          53.398600768500174
                                        ],
                                        [
                                          -6.32800430059433,
                                          53.398087405408646
                                        ],
                                        [
                                          -6.329012811183929,
                                          53.39771797206223
                                        ],
                                        [
                                          -6.329463422298431,
                                          53.39755324533716
                                        ],
                                        [
                                          -6.330002546310425,
                                          53.397353333406535
                                        ],
                                        [
                                          -6.330431699752808,
                                          53.39719820110123
                                        ],
                                        [
                                          -6.330914497375488,
                                          53.397009482689064
                                        ],
                                        [
                                          -6.3317084312438965,
                                          53.39672320485602
                                        ],
                                        [
                                          -6.332285106182098,
                                          53.39651209371193
                                        ],
                                        [
                                          -6.333502829074859,
                                          53.396069076769976
                                        ],
                                        [
                                          -6.334511339664459,
                                          53.39569322845604
                                        ],
                                        [
                                          -6.3349807262420645,
                                          53.395530093261215
                                        ],
                                        [
                                          -6.336037516593933,
                                          53.395127050687236
                                        ],
                                        [
                                          -6.336928009986877,
                                          53.39481996806892
                                        ],
                                        [
                                          -6.337882876396179,
                                          53.39444890694895
                                        ],
                                        [
                                          -6.339395642280579,
                                          53.39389550806152
                                        ],
                                        [
                                          -6.340908408164978,
                                          53.39332930637695
                                        ],
                                        [
                                          -6.342190504074097,
                                          53.39286866216162
                                        ],
                                        [
                                          -6.343402862548828,
                                          53.39242720677701
                                        ],
                                        [
                                          -6.344186067581177,
                                          53.39212970165271
                                        ],
                                        [
                                          -6.345511078834534,
                                          53.391640253213865
                                        ],
                                        [
                                          -6.347302794456482,
                                          53.3909876465404
                                        ],
                                        [
                                          -6.348643898963928,
                                          53.39049498585527
                                        ],
                                        [
                                          -6.3493412733078,
                                          53.39022625944183
                                        ],
                                        [
                                          -6.3502854108810425,
                                          53.3898871498799
                                        ],
                                        [
                                          -6.350907683372498,
                                          53.3896504114146
                                        ],
                                        [
                                          -6.351342201232909,
                                          53.389493651436034
                                        ],
                                        [
                                          -6.352377533912659,
                                          53.389116145445115
                                        ],
                                        [
                                          -6.35259747505188,
                                          53.38901377036208
                                        ],
                                        [
                                          -6.3538312911987305,
                                          53.3885466809214
                                        ],
                                        [
                                          -6.3549041748046875,
                                          53.38813717363383
                                        ],
                                        [
                                          -6.3553065061569205,
                                          53.38794201643109
                                        ],
                                        [
                                          -6.355649828910828,
                                          53.38776285493271
                                        ],
                                        [
                                          -6.356159448623657,
                                          53.387516506641255
                                        ],
                                        [
                                          -6.356690526008606,
                                          53.38726055885444
                                        ],
                                        [
                                          -6.357296705245972,
                                          53.386895830599464
                                        ],
                                        [
                                          -6.358128190040588,
                                          53.38638392602375
                                        ],
                                        [
                                          -6.358852386474609,
                                          53.385862416907706
                                        ],
                                        [
                                          -6.359882354736328,
                                          53.38507214245266
                                        ],
                                        [
                                          -6.360483169555664,
                                          53.38454421814597
                                        ],
                                        [
                                          -6.361314654350281,
                                          53.383837109273294
                                        ],
                                        [
                                          -6.36233925819397,
                                          53.38296680530839
                                        ],
                                        [
                                          -6.3634175062179565,
                                          53.3819940915897
                                        ],
                                        [
                                          -6.364635229110718,
                                          53.380934960264256
                                        ],
                                        [
                                          -6.365396976470947,
                                          53.3802629901751
                                        ],
                                        [
                                          -6.366276741027832,
                                          53.379495011374146
                                        ],
                                        [
                                          -6.366974115371704,
                                          53.37887101839986
                                        ],
                                        [
                                          -6.367800235748291,
                                          53.378176615469116
                                        ],
                                        [
                                          -6.370927691459655,
                                          53.37545649494422
                                        ],
                                        [
                                          -6.3719362020492545,
                                          53.37450601187244
                                        ],
                                        [
                                          -6.372789144515991,
                                          53.37363551718451
                                        ],
                                        [
                                          -6.3734060525894165,
                                          53.37298263449303
                                        ],
                                        [
                                          -6.374441385269164,
                                          53.37191687801014
                                        ],
                                        [
                                          -6.375326514244079,
                                          53.371222361687245
                                        ],
                                        [
                                          -6.375326514244079,
                                          53.371222361687245
                                        ],
                                        [
                                          -6.375626921653748,
                                          53.37101272435105
                                        ],
                                        [
                                          -6.3763269782066345,
                                          53.37061905145096
                                        ],
                                        [
                                          -6.377021670341492,
                                          53.37020777140521
                                        ],
                                        [
                                          -6.377378404140472,
                                          53.37000933136372
                                        ],
                                        [
                                          -6.377686858177185,
                                          53.36982209273505
                                        ],
                                        [
                                          -6.377987265586853,
                                          53.369615649190486
                                        ],
                                        [
                                          -6.378293037414551,
                                          53.369398002199674
                                        ],
                                        [
                                          -6.378668546676636,
                                          53.3691147393771
                                        ],
                                        [
                                          -6.379006505012511,
                                          53.36885067911737
                                        ],
                                        [
                                          -6.37943297624588,
                                          53.368495395458
                                        ],
                                        [
                                          -6.379829943180084,
                                          53.3680936973012
                                        ],
                                        [
                                          -6.380130350589752,
                                          53.36779442171022
                                        ],
                                        [
                                          -6.380516588687897,
                                          53.36729189005305
                                        ],
                                        [
                                          -6.380851864814758,
                                          53.36684856898835
                                        ],
                                        [
                                          -6.381082534790038,
                                          53.366510873674024
                                        ],
                                        [
                                          -6.381323933601379,
                                          53.36597631732519
                                        ],
                                        [
                                          -6.381527781486511,
                                          53.36540654329356
                                        ],
                                        [
                                          -6.38168066740036,
                                          53.364948797961894
                                        ],
                                        [
                                          -6.381860375404357,
                                          53.36435180103144
                                        ],
                                        [
                                          -6.3820481300353995,
                                          53.36365075910469
                                        ],
                                        [
                                          -6.382160782814026,
                                          53.3632522164284
                                        ],
                                        [
                                          -6.382313668727874,
                                          53.36270961618992
                                        ],
                                        [
                                          -6.382463872432709,
                                          53.36217341152625
                                        ],
                                        [
                                          -6.382581889629363,
                                          53.36176365057815
                                        ],
                                        [
                                          -6.382761597633362,
                                          53.36111378724439
                                        ],
                                        [
                                          -6.3828930258750916,
                                          53.36071522083847
                                        ],
                                        [
                                          -6.383021771907806,
                                          53.3603342582993
                                        ],
                                        [
                                          -6.383107602596283,
                                          53.359977302913556
                                        ],
                                        [
                                          -6.383252441883087,
                                          53.359538707897165
                                        ],
                                        [
                                          -6.383375823497772,
                                          53.35907449657572
                                        ],
                                        [
                                          -6.383512616157532,
                                          53.358703123877696
                                        ],
                                        [
                                          -6.383609175682067,
                                          53.35836216247342
                                        ],
                                        [
                                          -6.383708417415619,
                                          53.35799878745759
                                        ],
                                        [
                                          -6.383872032165527,
                                          53.357430507542844
                                        ],
                                        [
                                          -6.383979320526122,
                                          53.357004692837684
                                        ],
                                        [
                                          -6.384070515632629,
                                          53.35655326057182
                                        ],
                                        [
                                          -6.384199261665344,
                                          53.35604899547213
                                        ],
                                        [
                                          -6.384419202804565,
                                          53.35508847401461
                                        ],
                                        [
                                          -6.38469010591507,
                                          53.35389739734401
                                        ],
                                        [
                                          -6.384982466697693,
                                          53.35259581985934
                                        ],
                                        [
                                          -6.385159492492676,
                                          53.35184975629649
                                        ],
                                        [
                                          -6.3853418827056885,
                                          53.35106205269832
                                        ],
                                        [
                                          -6.38568788766861,
                                          53.34957626320158
                                        ],
                                        [
                                          -6.3859909772872925,
                                          53.348216912578806
                                        ],
                                        [
                                          -6.386125087738037,
                                          53.34760687188379
                                        ],
                                        [
                                          -6.386463046073914,
                                          53.34606812153736
                                        ],
                                        [
                                          -6.387283802032471,
                                          53.342705414491235
                                        ],
                                        [
                                          -6.387369632720946,
                                          53.34218016773007
                                        ],
                                        [
                                          -6.387444734573364,
                                          53.340758125736805
                                        ],
                                        [
                                          -6.387315988540649,
                                          53.33950899567486
                                        ],
                                        [
                                          -6.386854648590087,
                                          53.33823420470928
                                        ],
                                        [
                                          -6.385985612869263,
                                          53.33663265451465
                                        ],
                                        [
                                          -6.384902000427246,
                                          53.335300118917765
                                        ],
                                        [
                                          -6.381436586380005,
                                          53.33210314502438
                                        ],
                                        [
                                          -6.377928256988525,
                                          53.328790596687796
                                        ],
                                        [
                                          -6.374634504318237,
                                          53.325573910964
                                        ],
                                        [
                                          -6.371877193450928,
                                          53.32295296581401
                                        ],
                                        [
                                          -6.367607116699219,
                                          53.31785800302353
                                        ],
                                        [
                                          -6.3655686378479,
                                          53.315428869535715
                                        ],
                                        [
                                          -6.365134119987488,
                                          53.31504429746864
                                        ],
                                        [
                                          -6.364678144454956,
                                          53.31460203530794
                                        ],
                                        [
                                          -6.364238262176514,
                                          53.314217455791194
                                        ],
                                        [
                                          -6.360450983047485,
                                          53.30994198013137
                                        ],
                                        [
                                          -6.359785795211792,
                                          53.30932017364274
                                        ],
                                        [
                                          -6.358734369277954,
                                          53.30849963163209
                                        ],
                                        [
                                          -6.357511281967163,
                                          53.30778164443602
                                        ],
                                        [
                                          -6.355483531951904,
                                          53.30694825129948
                                        ],
                                        [
                                          -6.352812051773071,
                                          53.30589045966109
                                        ],
                                        [
                                          -6.350108385086059,
                                          53.30487110837902
                                        ],
                                        [
                                          -6.347780227661133,
                                          53.30400560233876
                                        ],
                                        [
                                          -6.345494985580444,
                                          53.303114433344305
                                        ],
                                        [
                                          -6.342582106590271,
                                          53.301963579680205
                                        ],
                                        [
                                          -6.340994238853455,
                                          53.30132883374824
                                        ],
                                        [
                                          -6.33810818195343,
                                          53.29977078100594
                                        ],
                                        [
                                          -6.336557865142822,
                                          53.29866792742424
                                        ],
                                        [
                                          -6.335726380348206,
                                          53.2979946597849
                                        ],
                                        [
                                          -6.334701776504517,
                                          53.2969494708992
                                        ],
                                        [
                                          -6.333602070808411,
                                          53.29563172698904
                                        ],
                                        [
                                          -6.332786679267883,
                                          53.294236990244656
                                        ],
                                        [
                                          -6.330828666687011,
                                          53.290924708777126
                                        ],
                                        [
                                          -6.326252818107605,
                                          53.28285936784876
                                        ],
                                        [
                                          -6.325507164001464,
                                          53.28151553089295
                                        ],
                                        [
                                          -6.325056552886963,
                                          53.280742564956384
                                        ],
                                        [
                                          -6.324557662010193,
                                          53.28004977032786
                                        ],
                                        [
                                          -6.323860287666321,
                                          53.27917413882756
                                        ],
                                        [
                                          -6.322851777076721,
                                          53.27825037626066
                                        ],
                                        [
                                          -6.322288513183594,
                                          53.27783660113653
                                        ],
                                        [
                                          -6.321660876274109,
                                          53.277454898051396
                                        ],
                                        [
                                          -6.320410966873168,
                                          53.276797334322325
                                        ],
                                        [
                                          -6.320040822029113,
                                          53.27661129006547
                                        ],
                                        [
                                          -6.319005489349365,
                                          53.27625202989852
                                        ],
                                        [
                                          -6.317814588546753,
                                          53.27589597443234
                                        ],
                                        [
                                          -6.317015290260315,
                                          53.27569388757809
                                        ],
                                        [
                                          -6.315765380859374,
                                          53.27547255326054
                                        ],
                                        [
                                          -6.314322352409363,
                                          53.27529612653439
                                        ],
                                        [
                                          -6.312627196311951,
                                          53.27520630901228
                                        ],
                                        [
                                          -6.311559677124023,
                                          53.275151776853185
                                        ],
                                        [
                                          -6.310449242591858,
                                          53.27508762128284
                                        ],
                                        [
                                          -6.309349536895752,
                                          53.27498497217003
                                        ],
                                        [
                                          -6.308813095092773,
                                          53.27492081634934
                                        ],
                                        [
                                          -6.3078635931015015,
                                          53.27475721857075
                                        ],
                                        [
                                          -6.306822896003722,
                                          53.2744781385622
                                        ],
                                        [
                                          -6.306077241897583,
                                          53.2742567979495
                                        ],
                                        [
                                          -6.305369138717651,
                                          53.27399375399192
                                        ],
                                        [
                                          -6.304553747177124,
                                          53.273615224480686
                                        ],
                                        [
                                          -6.303883194923401,
                                          53.27326556288622
                                        ],
                                        [
                                          -6.302708387374878,
                                          53.27247961583569
                                        ],
                                        [
                                          -6.302032470703125,
                                          53.27195350443033
                                        ],
                                        [
                                          -6.300095915794373,
                                          53.27055478652361
                                        ],
                                        [
                                          -6.298964023590088,
                                          53.26995165550762
                                        ],
                                        [
                                          -6.297558546066284,
                                          53.269351724194536
                                        ],
                                        [
                                          -6.2959277629852295,
                                          53.26875499271939
                                        ],
                                        [
                                          -6.2941789627075195,
                                          53.268344333963114
                                        ],
                                        [
                                          -6.29292368888855,
                                          53.26810692007036
                                        ],
                                        [
                                          -6.289758682250977,
                                          53.2675486713986
                                        ],
                                        [
                                          -6.287237405776977,
                                          53.267259919225616
                                        ],
                                        [
                                          -6.284737586975098,
                                          53.26707383345865
                                        ],
                                        [
                                          -6.282452344894409,
                                          53.266977581882095
                                        ],
                                        [
                                          -6.2794268131256095,
                                          53.26700324899036
                                        ],
                                        [
                                          -6.27793550491333,
                                          53.26714441781041
                                        ],
                                        [
                                          -6.276143789291382,
                                          53.26749733782147
                                        ],
                                        [
                                          -6.2737298011779785,
                                          53.268190335912614
                                        ],
                                        [
                                          -6.272860765457153,
                                          53.268453415579934
                                        ],
                                        [
                                          -6.271315813064575,
                                          53.26879349177556
                                        ],
                                        [
                                          -6.27042531967163,
                                          53.26891540522475
                                        ],
                                        [
                                          -6.2693095207214355,
                                          53.269024485384655
                                        ],
                                        [
                                          -6.267507076263427,
                                          53.269018068912374
                                        ],
                                        [
                                          -6.266273260116576,
                                          53.26890257224647
                                        ],
                                        [
                                          -6.264760494232178,
                                          53.26865874492726
                                        ],
                                        [
                                          -6.263000965118408,
                                          53.268228835477245
                                        ],
                                        [
                                          -6.261810064315796,
                                          53.26785667156712
                                        ],
                                        [
                                          -6.260823011398315,
                                          53.26755508809141
                                        ],
                                        [
                                          -6.2592995166778564,
                                          53.267189335064515
                                        ],
                                        [
                                          -6.257872581481934,
                                          53.266983998660606
                                        ],
                                        [
                                          -6.255737543106079,
                                          53.26690058046484
                                        ],
                                        [
                                          -6.253892183303833,
                                          53.26705458316068
                                        ],
                                        [
                                          -6.251821517944336,
                                          53.26744600418273
                                        ],
                                        [
                                          -6.249858140945435,
                                          53.268087670237485
                                        ],
                                        [
                                          -6.248645782470703,
                                          53.26868441102634
                                        ],
                                        [
                                          -6.246789693832397,
                                          53.26971104235572
                                        ],
                                        [
                                          -6.24548077583313,
                                          53.27029492792699
                                        ],
                                        [
                                          -6.244139671325683,
                                          53.27076331388483
                                        ],
                                        [
                                          -6.242841482162476,
                                          53.27114186864905
                                        ],
                                        [
                                          -6.241414546966553,
                                          53.27143701071601
                                        ],
                                        [
                                          -6.240878105163574,
                                          53.27155250053539
                                        ],
                                        [
                                          -6.239655017852783,
                                          53.271706486475935
                                        ],
                                        [
                                          -6.2383997440338135,
                                          53.271821975567335
                                        ],
                                        [
                                          -6.236940622329712,
                                          53.27185405581515
                                        ],
                                        [
                                          -6.234773397445679,
                                          53.271834807669336
                                        ],
                                        [
                                          -6.230664253234863,
                                          53.27186688790753
                                        ],
                                        [
                                          -6.228196620941162,
                                          53.272014456693064
                                        ],
                                        [
                                          -6.225106716156005,
                                          53.2721171129391
                                        ],
                                        [
                                          -6.2227463722229,
                                          53.27214277696207
                                        ],
                                        [
                                          -6.220901012420654,
                                          53.272027288737284
                                        ]
                             ]
                          },
                        }
                      },
                      "layout": {
                          "line-join": "round",
                          "line-cap": "round"
                      },
                      "paint": {
                          "line-color": "red",
                          "line-width": 3
                      },
            });
        });
  }

}

